name: Build Docs & Coverage Report

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
  workflow_dispatch: { }

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.152.2'
          extended: true

      - name: Diagnose Hugo modules
        run: |
          set -e
          cd docs
          hugo version || true
          hugo mod graph || true
          go env || true

      - name: Build Hugo site
        env:
          HUGO_ENV: production
        run: |
          set -e
          cd docs

          # Preserve any existing generated site so we can fall back if Hugo fails
          if [ -d public ]; then
            echo "Preserving existing docs/public to /tmp/preserved_public"
            rm -rf /tmp/preserved_public || true
            mkdir -p /tmp/preserved_public
            rsync -a public/ /tmp/preserved_public/ || true
          fi

          # Remove previous output directories (we will restore from preserved copy on failure)
          rm -rf publish public || true

          echo "Running hugo --verbose --debug (HUGO_ENV=$HUGO_ENV)"
          # Run Hugo; on failure, try to restore the preserved public copy if present
          if ! hugo --verbose --debug; then
            HUGO_EXIT=$?
            echo "Hugo exited with code $HUGO_EXIT"
            if [ -d /tmp/preserved_public ]; then
              echo "Restoring preserved docs/public because Hugo failed to produce output"
              mkdir -p public
              rsync -a /tmp/preserved_public/ public/
            else
              echo "No preserved docs/public available to restore"
              echo "Contents of docs after failed hugo:"
              find . -maxdepth 3 -type f -print || true
              exit $HUGO_EXIT
            fi
          fi

          echo "Built site directories (post-build):"
          [ -d publish ] && ls -la publish || echo "docs/publish missing"
          [ -d public ] && ls -la public || echo "docs/public missing"

      - name: Prepare site bundle
        run: |
          set -e
          if [ -f docs/publish/index.html ]; then
            SITE_DIR="docs/publish"
          elif [ -f docs/public/index.html ]; then
            SITE_DIR="docs/public"
          else
            echo "No index.html found."
            find docs -maxdepth 3 -name index.html || true
            exit 1
          fi
          echo "Using site dir: $SITE_DIR"
          mkdir -p /tmp/publish_copy
          rsync -a --delete "$SITE_DIR"/ /tmp/publish_copy/
          if [ -d docs/coverage-report ]; then
            rsync -a --delete docs/coverage-report/ /tmp/publish_copy/coverage-report/
          fi
          [ -f /tmp/publish_copy/index.html ] || { echo "Missing index.html in preserved copy"; exit 1; }
          echo "Sample of preserved copy:"
          find /tmp/publish_copy -maxdepth 2 -type f | head -n 20

      - name: Clean repository before branch switch
        run: |
          set -e
          git status --short
          git reset --hard
          git clean -fdx
          git status --short

      - name: Deploy to gh-pages
        env:
          GIT_COMMIT_MESSAGE: "Deploy docs from main: $GITHUB_SHA"
        run: |
          set -euo pipefail
          [ -d .git ] || { echo ".git missing before deploy"; exit 1; }

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git fetch origin

          if git ls-remote --exit-code --heads origin gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
          fi

          git rm -rf . || true
          git clean -fdx || true

          rsync -a /tmp/publish_copy/ ./
          touch .nojekyll

          [ -f index.html ] || { echo "index.html missing at root"; ls -la; exit 1; }
          git add -A
          STAGED_COUNT=$(git diff --cached --name-only | wc -l)
          if [ "$STAGED_COUNT" -gt 0 ]; then
            git commit -m "$GIT_COMMIT_MESSAGE"
            git push --force --set-upstream origin gh-pages
          else
            echo "No changes to commit."
          fi
